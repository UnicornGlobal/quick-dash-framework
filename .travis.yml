stages:
  - tests
  - name: deploy
    if: branch = master

dist: trusty
language: node_js
node_js:
- 9
services:
- mysql
addons:
  apt:
    sources:
      - mysql-5.7-trusty
    packages:
      - mysql-server
  chrome: stable

# Default steps within each job
before_install:
- phpenv global 7.1.11
- mysql -e 'CREATE DATABASE IF NOT EXISTS strong;'
- npm install
- cp config/secrets.env.js.example config/secrets.env.js
- export CHROME_BIN=/usr/bin/google-chrome
- export DISPLAY=:99.0
- sh -e /etc/init.d/xvfb start
- npm i chromedriver
- git clone "https://github.com/darrynten/strong-lumen" --branch=master ../strong-lumen
- cd ../strong-lumen
- composer self-update
- composer validate --no-check-all --ansi
- composer install -n
- cp .env.example .env
- php artisan migrate
- php artisan db:seed
- pwd
- touch ./storage/logs/lumen.log
- sudo chmod 777 ./storage/logs/lumen.log
- nohup php -S 127.0.0.1:8000 -t public &
- cd -

jobs:
  include:
    - stage: tests
      name: "Unit Tests"
      script: npm run unit
      after_success:
        - codecov test/unit/coverage/lcov.info -t ${CODECOV_TOKEN}
        - echo "Done"
    - stage: tests
      name: "e2e Tests"
      script: npm run e2e
    - stage: deploy
      name: "No target"
      before_install: true
      script: echo Add deployment settings!